# Story 4.7: Implement `delete custom mode` Command

**Status:** Draft

## Goal & Context

**User Story:** As a CLI User, I want a command `roo-init manage delete mode <slug>` to remove a custom mode and its associated rule files, so I can manage my personalized configurations.

**Context:** This story implements the "Delete" capability for custom modes, completing the CRUD lifecycle (Create - 4.2, Read - 4.4, Update - 4.5). Users will be able to remove custom modes they no longer need. This involves removing the mode definition from `~/.config/roo-init/user-definitions.json` and deleting its associated rule files and directory from `~/.config/roo-init/rules/`.

## Detailed Requirements

- Create the `roo-init manage delete mode <slug>` command. The `<slug>` argument is mandatory.
- Load the `user-definitions.json` file.
- Check if a custom mode with the given `<slug>` exists in the `customModes` array.
    - If not found, display an error message (e.g., "Custom mode with slug '<slug>' not found.") and exit.
    - If the slug corresponds to a system mode (even if overridden by a custom one with the same slug for listing/selection purposes, the `delete` command should only target *exclusively custom* definitions from `user-definitions.json`), an error like "System modes cannot be deleted. You can only delete modes you created." should be shown.
- If the custom mode is found, prompt the user for confirmation before deletion (e.g., "Are you sure you want to delete custom mode '<slug>' and its associated rules? (y/N)").
- If confirmed:
    - Remove the mode definition object from the `customModes` array in `user-definitions.json`.
    - Save the updated `user-definitions.json`.
    - Identify the associated rule files directory: `~/.config/roo-init/rules/[mode_slug]/`.
    - Delete this entire directory and its contents (all rule files for that custom mode).
    - Provide clear feedback of successful deletion.
- If not confirmed, exit gracefully with a message like "Deletion cancelled."

## Acceptance Criteria (ACs)

- AC1: User is prompted for confirmation before deleting a specified custom mode.
- AC2: If confirmed, the specified custom mode definition is removed from the `customModes` array in `~/.config/roo-init/user-definitions.json`.
- AC3: If confirmed, the associated rule files directory (`~/.config/roo-init/rules/[mode_slug]/`) and all its contents are deleted from the file system.
- AC4: Attempting to delete a non-existent custom mode slug results in an error message.
- AC5: Attempting to delete a slug that only exists as a system mode (and not as a custom mode in `user-definitions.json`) results in an error message indicating system modes cannot be deleted.
- AC6: If deletion is not confirmed by the user, no changes are made, and a cancellation message is shown.
- AC7: Successful deletion is confirmed with a message.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in [`docs/coding-standards.md`](docs/coding-standards.md:0) and understand the project structure in [`docs/project-structure.md`](docs/project-structure.md:0). Only story-specific details are included below.

- **Relevant Files:**
    - Files to Create:
        - `src/commands/manageDeleteMode.ts`
        - `tests/commands/manageDeleteMode.test.ts`
    - Files to Modify:
        - [`src/cli.ts`](src/cli.ts:0): Register the new command.
        - [`src/core/FileManager.ts`](src/core/FileManager.ts:0): Method to update `user-definitions.json` (remove a mode), method to delete a directory and its contents (for custom rules).
        - [`src/utils/uiManager.ts`](src/utils/uiManager.ts:0): For `inquirer` confirmation prompt.
        - [`src/core/DefinitionLoader.ts`](src/core/DefinitionLoader.ts:0): To distinguish between system and custom modes if needed for validation.
- **Key Technologies:**
    - `commander`: For command and argument parsing.
    - `inquirer`: For confirmation prompt (`confirm` type).
    - `fs-extra`: For file/directory deletion (`remove`) and updating `user-definitions.json`.
- **API Interactions / SDK Usage:**
    - `DefinitionLoader.getCustomDefinitions()` or `FileManager.readUserDefinitions()`: To find the mode to delete.
    - `FileManager.writeUserDefinitions()`: To save updated `user-definitions.json`.
    - `FileManager.deleteCustomRuleDirectory(modeSlug)` (new): To delete `~/.config/roo-init/rules/[mode_slug]/`.
    - `inquirer.prompt()`.
    - `fs-extra.remove(path)`: For deleting the rule directory.
- **UI/UX Notes:**
    - Confirmation prompt is critical to prevent accidental data loss.
- **Data Structures:**
    - `ModeDefinition` from [`docs/data-models.md`](docs/data-models.md:0).
- **Environment Variables:**
    - None.
- **Coding Standards Notes:**
    - Handle file system errors gracefully during deletion.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in [`docs/testing-strategy.md`](docs/testing-strategy.md:0).

- **Unit Tests ([`tests/unit/commands/manageDeleteMode.test.ts`](tests/unit/commands/manageDeleteMode.test.ts:0)):**
    - `manageDeleteMode.ts` command handler ([`src/commands/manageDeleteMode.ts`](src/commands/manageDeleteMode.ts:0)):
        - Mock `inquirer` (using `vi.mock` and `@inquirer/testing`) to simulate user confirmation (yes/no).
        - Mock `DefinitionLoader` ([`src/core/DefinitionLoader.ts`](src/core/DefinitionLoader.ts:0)) / `FileManager` ([`src/core/FileManager.ts`](src/core/FileManager.ts:0)) to:
            - Provide a list of custom modes (for finding the one to delete).
            - Simulate the removal of the mode from the data structure.
            - Validate if a slug refers to a non-existent custom mode or a system-only mode.
        - Mock `FileManager` ([`src/core/FileManager.ts`](src/core/FileManager.ts:0)) to verify it's called correctly to:
            - Read the initial `user-definitions.json`.
            - Write the updated `user-definitions.json` (with the mode removed).
            - Delete the custom rule directory (`~/.config/roo-init/rules/[mode_slug]/`).
        - Test error handling for:
            - Attempting to delete a non-existent custom mode slug.
            - Attempting to delete a system mode slug.
        - Test the cancellation flow (user answers 'no' to confirmation).
- **End-to-End (E2E) Tests ([`tests/e2e/manage-commands.e2e.test.ts`](tests/e2e/manage-commands.e2e.test.ts:0) or similar):**
    - Test the `roo-init manage delete mode <slug>` command by executing the CLI (via `cliTestRunner.ts`).
    - Requires setting up a temporary user-global configuration directory using `memfs` with:
        - A pre-existing `user-definitions.json` containing a custom mode to be deleted.
        - A corresponding rule directory and files for that custom mode (e.g., `~/.config/roo-init/rules/[mode_slug]/some-rule.md`).
    - Simulate user confirmation (yes/no) for the `inquirer` prompt.
    - Verify the orchestration of `DefinitionLoader`, `FileManager`, and `UiManager` by the `manageDeleteMode` command handler.
    - Assertions:
        - If confirmed 'yes':
            - The mode definition is removed from `user-definitions.json` in the temporary global config dir.
            - The entire `~/.config/roo-init/rules/[mode_slug]/` directory is deleted from the temporary global config dir.
            - The CLI provides appropriate success feedback.
        - If confirmed 'no':
            - No changes are made to `user-definitions.json` or the rule directory.
            - The CLI shows a "Deletion cancelled" message.
        - Test AC4 (non-existent custom slug) and AC5 (system slug) by providing such slugs and checking for error messages.
- **Manual/CLI Verification:**
    - First, create a custom mode with a few rules using `roo-init manage add mode`.
    - Run `roo-init manage delete mode <slug_of_created_mode>` interactively:
        - Confirm 'yes' to deletion. Verify the mode is removed from the actual `~/.config/roo-init/user-definitions.json` and its rule directory `~/.config/roo-init/rules/[mode_slug]/` is deleted.
    - Create another custom mode. Run `roo-init manage delete mode <slug>` again.
        - Confirm 'no' to deletion. Verify no changes were made to `user-definitions.json` or the rules directory.
    - Test error conditions:
        - `roo-init manage delete mode nonexistentslug`
        - `roo-init manage delete mode <a_system_mode_slug>`

## Tasks / Subtasks

- [ ] **Setup `manage delete mode` Command:**
    - [ ] In [`src/cli.ts`](src/cli.ts:0), add `delete mode <slug>` as a subcommand to `manage`.
    - [ ] Create `src/commands/manageDeleteMode.ts` and handler structure.
- [ ] **Load and Validate Mode:**
    - [ ] Implement logic to load `user-definitions.json`.
    - [ ] Find the custom mode by slug. Handle "not found" error.
    - [ ] Validate that it's a custom mode, not a system-only mode.
- [ ] **Implement Confirmation Prompt:**
    - [ ] Use `inquirer` to ask for confirmation before deletion.
- [ ] **File Management Logic (`FileManager`):**
    - [ ] Ensure `FileManager.writeUserDefinitions` can save `user-definitions.json` after a mode is removed from its `customModes` array.
    - [ ] Add `FileManager.deleteCustomRuleDirectory(modeSlug)` to delete `~/.config/roo-init/rules/[mode_slug]/` using `fs-extra.remove`.
- [ ] **Perform Deletion:**
    - [ ] If confirmed:
        - Remove mode from the loaded `customModes` array.
        - Call `FileManager.writeUserDefinitions` to save changes.
        - Call `FileManager.deleteCustomRuleDirectory`.
- [ ] **User Feedback and Error Handling:**
    - [ ] Implement success, cancellation, and error messages.
- [ ] **Unit & Integration Tests:**
    - [ ] Write comprehensive tests.
- [ ] **Documentation:**
    - [ ] JSDoc and user guide updates.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
  - ...