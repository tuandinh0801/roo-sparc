# Story 4.2: Implement `add custom mode` Command

**Status:** Draft

## Goal & Context

**User Story:** As a CLI User, I want an interactive command `roo-init manage add mode` to define a new custom mode, including its rules with content edited in-CLI, and save it to my global user configuration.

**Context:** This story builds upon Story 4.1, which established user-global storage and enhanced definition loading. It introduces the first CRUD (Create) operation for custom modes, allowing users to personalize their `roo-init` experience. This command will interactively guide the user through defining all aspects of a new mode, including its metadata and associated rule files (with content). The new mode will be saved to `~/.config/roo-init/user-definitions.json`, and its rule files to `~/.config/roo-init/rules/[mode_slug]/`. This is a key feature for user empowerment and extensibility of the CLI.

## Detailed Requirements

- Create the `roo-init manage add mode` command.
- Interactively prompt for:
    - `slug`: Must be unique among *other custom modes*. Validation needed.
    - `name`: Human-readable name for the mode.
    - `description` (`roleDefinition`): Detailed description of the mode.
    - `customInstructions` (optional): Specific instructions for the mode.
    - `groups` (optional, multi-select from a predefined list or allow freeform text input, TBD by dev agent - simpler is freeform comma-separated string for MVP, then parse into array).
    - `categorySlugs` (multi-select from existing system AND custom categories, loaded via `DefinitionLoader`).
- For `associatedRuleFiles`:
    - Repeatedly ask the user if they want to add a rule (e.g., "Add another rule? (y/N)").
    - If yes:
        - Prompt for rule `name` (human-readable display name).
        - Prompt for rule `filename` (e.g., `my-rule.md`). Validate for valid filename characters.
        - Prompt for rule `description` (optional, brief purpose).
        - Prompt for `isGeneric` (boolean, e.g., "Is this a generic rule (applies to .roo/rules/)? (y/N)", defaults to `false` meaning mode-specific).
        - Use an `inquirer` `editor` type prompt for the rule's Markdown content.
        - The `FileManager` service will handle saving the rule content to `~/.config/roo-init/rules/[mode_slug]/[filename]`. The `[mode_slug]` subdirectory under `~/.config/roo-init/rules/` must be created if it doesn't exist.
        - Store rule metadata (including `id` (can be derived from filename or be a UUID), `name`, `description`, `sourcePath`: `"[mode_slug]/[filename]"`, `isGeneric`) in the mode object being constructed. The `sourcePath` is relative to `~/.config/roo-init/rules/`.
- Save the complete new mode definition (as a `ModeDefinition` object) by appending it to the `customModes` array in `~/.config/roo-init/user-definitions.json`. If the file doesn't exist, it should be created with the appropriate structure (e.g., `{"customModes": [], "customCategories": []}`).

## Acceptance Criteria (ACs)

- AC1: User can successfully create a new custom mode with all its fields (slug, name, description, customInstructions, groups, categorySlugs) via interactive prompts.
- AC2: For each rule added to the custom mode:
    - User is prompted for rule metadata (name, filename, description, isGeneric).
    - User can input Markdown content using an editor prompt.
    - The rule's Markdown content is saved to `~/.config/roo-init/rules/[mode_slug]/[filename]`.
    - The `[mode_slug]` subdirectory under `~/.config/roo-init/rules/` is created if it doesn't already exist.
- AC3: The new mode definition, including metadata for all its associated rules (with correct `sourcePath`), is correctly appended to the `customModes` array in `~/.config/roo-init/user-definitions.json`.
- AC4: Input validation for the mode `slug` ensures it is unique among existing *custom mode slugs* (loaded via `DefinitionLoader`). If a duplicate custom slug is entered, an error is shown, and the user is re-prompted. Validation for rule `filename` ensures it's a valid filename.
- AC5: If `user-definitions.json` doesn't exist, it's created with the new mode. If it exists but is empty or malformed, appropriate error handling or initialization occurs before appending (e.g., initialize with `{"customModes": [], "customCategories": []}` if empty or unparsable).
- AC6: The command provides clear feedback to the user upon successful creation of the mode and its rules.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in [`docs/coding-standards.md`](docs/coding-standards.md:0) and understand the project structure in [`docs/project-structure.md`](docs/project-structure.md:0). Only story-specific details are included below.

- **Relevant Files:**
    - Files to Create:
        - `src/commands/manageAddMode.ts`: Handler for the `roo-init manage add mode` command.
        - `tests/commands/manageAddMode.test.ts`: Unit/integration tests for the command.
    - Files to Modify:
        - [`src/cli.ts`](src/cli.ts:0): To register the new `manage add mode` command with `commander`.
        - [`src/core/FileManager.ts`](src/core/FileManager.ts:0): To add methods for writing/updating `user-definitions.json` and saving custom rule files to the user-global storage, including creating `~/.config/roo-init/rules/[mode_slug]/` directories. Refer to [`docs/architecture.md:216`](docs/architecture.md:216).
        - [`src/utils/uiManager.ts`](src/utils/uiManager.ts:0): May need new reusable prompt sequences or to ensure `inquirer.prompt` (including `editor` type) is well-supported. Refer to [`docs/architecture.md:220`](docs/architecture.md:220).
        - [`src/types/domain.ts`](src/types/domain.ts:0): Ensure `Rule` interface includes `filename` if not already present, or clarify how `id` and `sourcePath` are derived/used for custom rules.
- **Key Technologies:**
    - `commander`: To define the `manage add mode` subcommand.
    - `inquirer`: For all interactive prompts, especially `input`, `checkbox` (for categories, groups if applicable), `confirm`, and `editor` types.
    - `fs-extra`: For reading/writing `user-definitions.json` and writing rule files to `~/.config/roo-init/rules/[mode_slug]/[filename]`.
    - `DefinitionLoader` ([`src/core/DefinitionLoader.ts`](src/core/DefinitionLoader.ts:0)): To load existing custom categories (for selection) and to check for custom mode slug uniqueness.
- **API Interactions / SDK Usage:**
    - `DefinitionLoader.getMergedDefinitions()`: To fetch existing categories and check custom mode slug uniqueness.
    - `FileManager.readUserDefinitions()` (new or existing): To get current custom modes/categories.
    - `FileManager.writeUserDefinitions(data)` (new): To save updated custom modes/categories.
    - `FileManager.saveCustomRuleFile(modeSlug, ruleFilename, content)` (new): To save rule content.
    - `inquirer.prompt([...questions])`: For all user interactions.
- **UI/UX Notes:**
    - Prompts should be clear and guide the user step-by-step.
    - Provide defaults where sensible (e.g., `isGeneric: false` for rules).
    - The `editor` prompt should launch the system's default editor or a basic in-terminal editor.
- **Data Structures:**
    - `ModeDefinition`, `CategoryDefinition`, `Rule` from [`docs/data-models.md`](docs/data-models.md:0).
    - The `Rule` object stored in `ModeDefinition.associatedRuleFiles` for a custom rule should have `sourcePath` like `"[mode_slug]/[filename]"` and `isGeneric` set by user. `id` could be derived from `filename` (e.g., `filename` without `.md`).
- **Environment Variables:**
    - None. Refer to [`docs/environment-vars.md`](docs/environment-vars.md:0).
- **Coding Standards Notes:**
    - Modularize prompt sequences if they become complex.
    - Ensure robust error handling for file operations and input validation.
    - Use `async/await` for all asynchronous operations (prompts, file I/O).

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. Follow general testing approach in [`docs/testing-strategy.md`](docs/testing-strategy.md:0).

- **Unit Tests ([`tests/unit/commands/manageAddMode.test.ts`](tests/unit/commands/manageAddMode.test.ts:0)):**
    - `manageAddMode.ts` command handler ([`src/commands/manageAddMode.ts`](src/commands/manageAddMode.ts:0)):
        - Mock `inquirer` (using `vi.mock` and potentially `@inquirer/testing` for complex prompt sequences if `UiManager` is used directly) to simulate various user input scenarios:
            - All fields filled correctly.
            - Optional fields (like `customInstructions`, `groups`) skipped.
            - Adding multiple rules.
            - Adding no rules.
            - User inputting a duplicate custom slug (for re-prompt validation).
            - User inputting an invalid rule filename.
        - Mock `DefinitionLoader` ([`src/core/DefinitionLoader.ts`](src/core/DefinitionLoader.ts:0)) to provide existing system/custom categories (for selection) and existing custom mode slugs (for uniqueness validation).
        - Mock `FileManager` ([`src/core/FileManager.ts`](src/core/FileManager.ts:0)) to verify it's called with the correct data and paths to:
            - Read existing `user-definitions.json`.
            - Write the updated `user-definitions.json` with the new mode.
            - Save each custom rule file content to the correct user-global path (`~/.config/roo-init/rules/[mode_slug]/[filename]`).
            - Ensure the `[mode_slug]` directory under `~/.config/roo-init/rules/` is created.
        - Test internal input validation logic within the command handler (e.g., for slug uniqueness against custom modes, valid rule filenames).
- **End-to-End (E2E) Tests ([`tests/e2e/manage-commands.e2e.test.ts`](tests/e2e/manage-commands.e2e.test.ts:0) or similar):**
    - Test the `roo-init manage add mode` command by executing the CLI (via `cliTestRunner.ts`).
    - Simulate user interaction with `inquirer` prompts. This might involve:
        - Using `@inquirer/testing` if `cliTestRunner` can be adapted, or providing answers via a sequence if `inquirer` mocks allow this at E2E level.
        - For the `editor` prompt, test with pre-canned simple content.
    - Set up a temporary user-global configuration directory using `memfs` (via `vol` and `tmpdir-fixture.ts` adapted for global paths if necessary, or by directly populating `memfs` at the known global path before test execution).
    - Verify the orchestration of `DefinitionLoader`, `FileManager`, and `UiManager` by the `manageAddMode` command handler.
    - Assertions:
        - The `user-definitions.json` in the temporary global config dir is created/updated correctly with the new mode and its rule metadata.
        - Custom rule files are created in the temporary `~/.config/roo-init/rules/[mode_slug]/` with the correct content.
        - The CLI provides appropriate success feedback.
        - Test error handling for scenarios like attempting to add a mode with a slug that already exists as a custom mode.
- **Manual/CLI Verification (Essential for `editor` prompt behavior and full interactive flow):**
    - Run `roo-init manage add mode` interactively in a real terminal.
    - Provide inputs for all fields, including `customInstructions` and `groups`.
    - Add at least two rules: one generic, one specific. For each, use the `editor` prompt to input multi-line Markdown content.
    - Verify that `user-definitions.json` in the actual `~/.config/roo-init/` directory is updated correctly with the new mode and its rule details (including `sourcePath` and `isGeneric` flags).
    - Verify that rule files are created in `~/.config/roo-init/rules/[mode_slug]/` with the exact content entered in the editor.
    - Test slug uniqueness validation by attempting to add a mode with a slug that already exists as a custom mode.
    - Test adding a mode when `user-definitions.json` does not initially exist (it should be created).
    - Test adding a mode when `user-definitions.json` exists but is empty or malformed (verify AC5).

## Tasks / Subtasks

- [ ] **Setup `manage add mode` Command:**
    - [ ] In [`src/cli.ts`](src/cli.ts:0), add `manage` as a top-level command if it doesn't exist.
    - [ ] Add `add mode` as a subcommand to `manage`.
    - [ ] Create `src/commands/manageAddMode.ts` and basic handler structure.
- [ ] **Implement Interactive Prompts:**
    - [ ] Design `inquirer` prompt sequence for mode metadata (`slug`, `name`, `description`, `customInstructions`, `groups`, `categorySlugs`).
        - Fetch existing system and custom categories from `DefinitionLoader` for `categorySlugs` prompt.
    - [ ] Implement slug uniqueness check against existing *custom* modes from `DefinitionLoader`. Re-prompt if not unique.
    - [ ] Implement loop for adding rules:
        - Prompt for rule metadata (`name`, `filename`, `description`, `isGeneric`). Validate `filename`.
        - Implement `editor` prompt for rule content.
- [ ] **File Management Logic (`FileManager`):**
    - [ ] Add method to `FileManager` to read `user-definitions.json`. Handle file not existing or being empty/invalid.
    - [ ] Add method to `FileManager` to write/update `user-definitions.json` (append to `customModes` array).
    - [ ] Add method to `FileManager` to save a custom rule's content to `~/.config/roo-init/rules/[mode_slug]/[filename]`. Ensure `[mode_slug]` directory is created.
- [ ] **Assemble and Save Mode:**
    - [ ] Construct the `ModeDefinition` object with all collected data, including `associatedRuleFiles` array.
    - [ ] Use `FileManager` to save the new mode to `user-definitions.json`.
- [ ] **User Feedback:**
    - [ ] Implement success messages upon completion.
    - [ ] Implement clear error messages for validation failures or file operation issues.
- [ ] **Unit & Integration Tests:**
    - [ ] Write unit tests for `manageAddMode.ts` command logic with mocked dependencies.
    - [ ] Write integration tests focusing on `FileManager` interactions for saving data to a temporary global config.
- [ ] **Documentation:**
    - [ ] Add JSDoc for new command handler and `FileManager` methods.
    - [ ] Update user guide/CLI reference if applicable.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
  - ...